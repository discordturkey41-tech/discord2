<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Servers - Premium Bot Panel</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">
                Loading<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>
            </div>
        </div>
    </div>

    <header>
        <nav>
            <div class="logo">‚ö° Bot Command Center</div>
            <div class="nav-links">
                <a href="/dashboard">Dashboard</a>
                <a href="/servers">Servers</a>
                <a href="/logout">Logout</a>
            </div>
        </nav>
    </header>

    <div class="page-content hidden" id="pageContent">
        <div class="container fade-in">
            <!-- Header Section -->
            <div class="section mb-2xl">
                <div style="text-align: center; margin-bottom: 20px;">
                    <img src="https://cdn.discordapp.com/avatars/<%= user.id %>/<%= user.avatar %>.png?size=256" 
                         alt="Your Avatar" 
                         style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid rgba(0, 212, 255, 0.5); box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);"
                         onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'">
                </div>
                <h1>Your Discord Servers</h1>
                <p class="section-description">
                    Manage bot settings, configure permissions, and access advanced tools 
                    for each of your Discord communities
                </p>
            </div>

            <!-- Bot Capabilities Info -->
            <div class="section mb-2xl">
                <h2 class="section-title mb-xl">What You Can Control</h2>
                <div class="feature-grid mb-2xl">
                    <div class="feature-card">
                        <div class="feature-icon">üõ°Ô∏è</div>
                        <div class="feature-title">Security & Moderation</div>
                        <p class="feature-description">
                            Configure auto-moderation, set warning thresholds, 
                            and manage member permissions
                        </p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">üí¨</div>
                        <div class="feature-title">Command Settings</div>
                        <p class="feature-description">
                            Enable/disable commands per server, set command prefixes, 
                            and customize responses
                        </p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">üë•</div>
                        <div class="feature-title">Member Management</div>
                        <p class="feature-description">
                            Welcome messages, role assignments, member tracking, 
                            and activity monitoring
                        </p>
                    </div>
                </div>
            </div>

            <!-- Servers Grid -->
            <div class="section">
                <h2 class="section-title mb-xl">
                    <%= guilds && guilds.length > 0 ? guilds.length + ' Server(s)' : 'No Servers Found' %>
                </h2>
                
                <% if (guilds && guilds.length > 0) { %>
                    <div class="servers-list" id="serversList">
                        <% guilds.forEach(guild => { %>
                            <% 
                                let initials = '';
                                const words = guild.name.trim().split(/\s+/);
                                if (words.length === 1) {
                                    // One word: use first 2 letters
                                    initials = words[0].substring(0, 2).toUpperCase();
                                } else {
                                    // Multiple words: use first letter of first two words
                                    initials = (words[0].charAt(0) + words[1].charAt(0)).toUpperCase();
                                }
                                const hue = Math.abs(guild.id.charCodeAt(0) * 12);
                            %>
                            <div class="server slide-in-left" data-server-id="<%= guild.id %>">
                                <% if (guild.icon) { %>
                                    <img src="https://cdn.discordapp.com/icons/<%= guild.id %>/<%= guild.icon %>.png?size=256" 
                                         class="server-avatar" 
                                         alt="<%= guild.name %>"
                                         data-initials="<%= initials %>"
                                         data-hue="<%= hue %>"
                                         onerror="this.style.display='none'; const fallback=document.createElement('div'); fallback.className='server-avatar server-avatar-fallback'; fallback.style.background='hsl('+this.dataset.hue+', 70%, 60%)'; fallback.textContent=this.dataset.initials; this.parentElement.insertBefore(fallback, this);">
                                <% } else { %>
                                    <div class="server-avatar server-avatar-fallback" style="background: hsl(<%= hue %>, 70%, 60%); display: flex; align-items: center; justify-content: center; font-size: 1.8em; font-weight: 700; color: white; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">
                                        <%= initials %>
                                    </div>
                                <% } %>
                                <div class="server-info">
                                    <span class="server-name"><%= guild.name %></span>
                                    <% 
                                        const memberCount = guild.member_count || guild.approximate_member_count; 
                                        const formattedCount = memberCount ? new Intl.NumberFormat().format(memberCount) : '0';
                                    %>
                                    <% if (memberCount) { %>
                                        <div class="server-members">üë• <%= formattedCount %> members</div>
                                    <% } %>
                                    <% if (guild.owner) { %>
                                        <div class="server-owner">üëë You Own This Server</div>
                                    <% } %>
                                </div>
                                <div class="server-actions">
                                    <button class="btn btn-secondary btn-action" data-server-id="<%= guild.id %>" style="width: 100%; display: flex; justify-content: center; align-items: center; min-height: 42px;">
                                        <div class="spinner spinner-xs"></div>
                                    </button>
                                </div>
                            </div>
                        <% }) %>
                    </div>

                    <!-- Server Management Info -->
                    <div class="card mt-2xl">
                        <h3 class="text-accent mb-md">üìã Server Management Tips</h3>
                        <ul style="color: var(--text-secondary); line-height: 2; padding-left: 1.5rem;">
                            <li>Click any server to access detailed configuration options</li>
                            <li>Configure moderation rules and auto-responses</li>
                            <li>Set up custom command prefixes for each server</li>
                            <li>Monitor member activity and server analytics</li>
                            <li>Create automated welcome messages and role assignments</li>
                            <li>Manage permissions and access control</li>
                        </ul>
                    </div>
                <% } else { %>
                    <div class="card text-center p-lg">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ü§î</div>
                        <h3 class="text-secondary">No Servers Found</h3>
                        <p class="mt-md">
                            You need to be an administrator of a server to manage it with this bot. 
                            Make sure you have the required permissions on your Discord servers.
                        </p>
                    </div>
                <% } %>
            </div>

            <!-- Action Buttons -->
            <div class="section mt-2xl">
                <div class="flex gap-lg">
                    <a href="/dashboard" class="btn btn-secondary">
                        <span>‚Üê</span> Back to Dashboard
                    </a>
                    <a href="/logout" class="btn btn-danger">
                        <span>üö™</span> Logout
                    </a>
                </div>
            </div>

            <!-- FAQ Section -->
            <div class="section mt-2xl">
                <h2 class="section-title mb-xl">Frequently Asked Questions</h2>
                <div class="card mb-lg">
                    <h4 class="text-primary mb-sm">Why don't I see some of my servers?</h4>
                    <p class="text-secondary">
                        Only servers where you have Administrator permissions are displayed. 
                        Contact your server owner if you need access to be granted.
                    </p>
                </div>
                <div class="card mb-lg">
                    <h4 class="text-primary mb-sm">How do I configure bot settings?</h4>
                    <p class="text-secondary">
                        Select a server from the list above to access its configuration panel. 
                        All settings are per-server to give you full flexibility.
                    </p>
                </div>
                <div class="card">
                    <h4 class="text-primary mb-sm">Is there support available?</h4>
                    <p class="text-secondary">
                        Yes! Our support team is available 24/7 on Discord. 
                        Join our support server for assistance with any issues.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script src="/script.js"></script>
    <script>
        const BOT_CLIENT_ID = '1304793456740270162';
        const INVITE_URL = `https://discord.com/oauth2/authorize?client_id=${BOT_CLIENT_ID}&permissions=8&scope=bot%20applications.commands&integration_type=0`;

        // Load bot status for all servers
        async function loadBotStatus() {
            try {
                console.log('=== Starting loadBotStatus ===');
                const response = await fetch('/api/server-bot-status');
                if (!response.ok) {
                    console.error('Failed to fetch bot status, status:', response.status);
                    const text = await response.text();
                    console.error('Response body:', text);
                    return;
                }

                const botStatus = await response.json();
                console.log('Bot status data received:', botStatus);

                if (!Array.isArray(botStatus)) {
                    console.error('Bot status is not an array:', botStatus);
                    return;
                }

                let updated = 0;
                botStatus.forEach(server => {
                    const button = document.querySelector(`.btn-action[data-server-id="${server.id}"]`);
                    if (!button) {
                        console.warn(`Button not found for server ${server.id}`);
                        return;
                    }

                    const currentState = button.getAttribute('data-bot-present');
                    console.log(`%c[${server.name}] Current: ${currentState}, API says: ${server.hasBotAccess}`, 'color: #00d4ff; font-weight: bold;');

                    if (server.hasBotAccess) {
                        // Bot is in the server - show manage button
                        if (currentState !== 'true') {
                            console.log(`‚úì UPDATING ${server.name} to MANAGE button`);
                            button.className = 'btn btn-primary btn-action';
                            button.innerHTML = '<span class="action-icon">‚öôÔ∏è</span> Manage Server';
                            button.style.cursor = 'pointer';
                            button.setAttribute('data-bot-present', 'true');
                            button.onclick = function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                manageServer(server.id, server.name);
                            };
                            updated++;
                        }
                    } else {
                        // Bot not in server - show add button
                        if (currentState !== 'false') {
                            console.log(`‚úó UPDATING ${server.name} to ADD button`);
                            button.className = 'btn btn-secondary btn-action';
                            button.innerHTML = '<span class="action-icon">‚ûï</span> Add to Server';
                            button.style.cursor = 'pointer';
                            button.setAttribute('data-bot-present', 'false');
                            button.onclick = function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                addBotToServer(server.id, server.name);
                            };
                            updated++;
                        }
                    }
                });
                console.log(`=== loadBotStatus complete (${updated} buttons updated) ===\n`);
                hideLoadingOverlay();
            } catch (error) {
                console.error('Error loading bot status:', error.message || error);
                hideLoadingOverlay();
            }
        }

        function hideLoadingOverlay() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const pageContent = document.getElementById('pageContent');
            if (loadingOverlay) loadingOverlay.classList.add('hidden');
            if (pageContent) pageContent.classList.remove('hidden');
        }

        function addBotToServer(serverId, serverName) {
            console.log(`Adding bot to server: ${serverName} (${serverId})`);
            
            // Open invite in new tab
            const width = 500;
            const height = 700;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            
            const popup = window.open(
                INVITE_URL,
                'Add Bot',
                `width=${width},height=${height},left=${left},top=${top}`
            );

            if (!popup) {
                console.error('Popup blocked or failed to open');
                // Fallback: redirect to invite URL
                window.open(INVITE_URL);
                // Check after longer delay if popup was blocked
                setTimeout(loadBotStatus, 3000);
                return;
            }

            // Refresh status every 1.5 seconds while popup is open
            let checkCount = 0;
            const checkPopupInterval = setInterval(() => {
                checkCount++;
                try {
                    if (popup.closed) {
                        clearInterval(checkPopupInterval);
                        console.log('Popup closed, checking bot status...');
                        // Wait a moment then refresh bot status multiple times
                        setTimeout(loadBotStatus, 500);
                        setTimeout(loadBotStatus, 2000);
                        setTimeout(loadBotStatus, 4000);
                    }
                } catch (e) {
                    console.error('Error checking popup status:', e.message);
                }
                
                // Safety timeout after 30 seconds
                if (checkCount > 20) {
                    clearInterval(checkPopupInterval);
                    console.log('Popup check timeout, refreshing status');
                    setTimeout(loadBotStatus, 1000);
                }
            }, 1500);
        }

        function manageServer(serverId, serverName) {
            console.log(`Managing server: ${serverName} (${serverId})`);
            // Navigate to server management page
            window.location.href = `/server/${serverId}`;
        }

        // Load bot status on page load
        window.addEventListener('load', () => {
            console.log('Page loaded, loading bot status once...');
            loadBotStatus();
        });
    </script>
</body>
</html>

